# SAM3 Inference API - Jetson Optimized Container
#
# Uses SAM3's native VETextEncoder for text prompt support
# Optimized for Jetson AGX Orin with JetPack 6.x
#
# Build:
#   docker build -f Dockerfile.jetson -t sam3-edge:jetson .
#
# Run:
#   docker run --runtime nvidia --gpus all -p 8000:8000 \
#     -v ~/.cache/sam3_deepstream/engines:/workspace/engines:ro \
#     sam3-edge:jetson

ARG L4T_VERSION=r36.4.0
FROM dustynv/l4t-pytorch:${L4T_VERSION}

# Set environment
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

WORKDIR /workspace

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    libsqlite3-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy constraints file first (for pip to use)
COPY sam3_deepstream/constraints.txt /workspace/

# Install Python dependencies with constraints (prevents numpy 2.x)
RUN pip3 install --no-cache-dir --index-url https://pypi.org/simple/ \
    -c /workspace/constraints.txt \
    fastapi>=0.104.0 \
    "uvicorn[standard]>=0.24.0" \
    python-multipart>=0.0.6 \
    pydantic>=2.0.0 \
    pillow>=10.0.0 \
    aiofiles>=23.0.0 \
    aiosqlite>=0.19.0 \
    faiss-cpu>=1.7.2 \
    einops>=0.7.0 \
    triton>=2.1.0 \
    decord2>=3.0.0 \
    pycocotools>=2.0.0

# Copy and install sam3 package (non-editable for proper caching)
COPY sam3 /workspace/sam3
RUN pip3 install --no-cache-dir --index-url https://pypi.org/simple/ \
    -c /workspace/constraints.txt \
    /workspace/sam3 && \
    rm -rf /workspace/sam3

# Copy sam3_deepstream package
COPY sam3_deepstream/sam3_deepstream /workspace/sam3_deepstream
COPY pyproject.toml /workspace/

# Install sam3_deepstream (non-editable)
RUN pip3 install --no-cache-dir --index-url https://pypi.org/simple/ \
    -c /workspace/constraints.txt \
    .

# Install test dependencies
RUN pip3 install --no-cache-dir --index-url https://pypi.org/simple/ \
    pytest>=7.0.0 \
    pytest-asyncio>=0.21.0 \
    requests>=2.28.0

# Copy tests and scripts (test_data should be mounted at runtime if needed)
COPY sam3_deepstream/tests /workspace/tests
COPY sam3_deepstream/scripts /workspace/scripts

# Create directories
RUN mkdir -p /workspace/engines /workspace/uploads /workspace/db

# Environment configuration
ENV SAM3_ENCODER_ENGINE=/workspace/engines/sam3_encoder.engine
ENV SAM3_DECODER_ENGINE=/workspace/engines/sam3_decoder.engine
ENV SAM3_CHECKPOINT=/workspace/checkpoints/sam3.pt
ENV CUDA_DEVICE=0
ENV HOST=0.0.0.0
ENV PORT=8000

# PE (Perception Encoder) configuration
# Set SAM3_USE_PE_BACKBONE=1 to use PE-enhanced backbone
ENV SAM3_USE_PE_BACKBONE=0
ENV SAM3_PE_ENCODER_ENGINE=/workspace/engines/pe_encoder_fp16.engine
ENV SAM3_ALIGNMENT_TUNING=1

# Jetson-specific optimizations
ENV CUDA_CACHE_DISABLE=0
ENV CUDA_CACHE_PATH=/workspace/.cuda_cache
ENV TRT_ENGINE_CACHE_ENABLE=1
ENV PYTORCH_CUDA_ALLOC_CONF=max_split_size_mb:512

EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=3 \
    CMD python3 -c "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')" || exit 1

# Default command
CMD ["python3", "-m", "sam3_deepstream.api.server"]
